name: Update Dependency Checkboxes

on:
  issues:
    types: [closed]
  pull_request:
    types: [closed]

jobs:
  update-checkboxes:
    runs-on: ubuntu-latest
    if: github.event.issue.state == 'closed' || github.event.pull_request.merged == true
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Update dependency checkboxes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const closedNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            console.log(`Issue/PR #${closedNumber} was closed`);
            
            // Find all open issues that reference this issue
            const searchQuery = `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open #${closedNumber}`;
            
            const searchResults = await github.rest.search.issuesAndPullRequests({
              q: searchQuery,
              per_page: 100
            });
            
            console.log(`Found ${searchResults.data.total_count} issues referencing #${closedNumber}`);
            
            for (const issue of searchResults.data.items) {
              const body = issue.body || '';
              
              // Check if this issue has a checkbox for the closed issue
              const uncheckedPattern = new RegExp(`- \\[ \\] #${closedNumber}\\b`, 'g');
              
              if (uncheckedPattern.test(body)) {
                console.log(`Updating checkbox in issue #${issue.number}`);
                
                // Replace unchecked with checked
                const updatedBody = body.replace(
                  uncheckedPattern,
                  `- [x] #${closedNumber}`
                );
                
                // Update the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: updatedBody
                });
                
                // Check if all dependencies are now resolved
                const remainingUnchecked = updatedBody.match(/- \[ \] #\d+/g);
                
                if (!remainingUnchecked || remainingUnchecked.length === 0) {
                  // All dependencies resolved, add comment
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `✅ All dependencies are now resolved! This issue is ready for implementation.`
                  });
                  
                  console.log(`All dependencies resolved for issue #${issue.number}`);
                } else {
                  console.log(`Issue #${issue.number} still has ${remainingUnchecked.length} pending dependencies`);
                }
              }
            }
            
            console.log('✅ Checkbox updates complete');
